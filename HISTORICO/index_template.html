<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Participación 2023</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link media="all" rel="stylesheet"
        href="https://css2.rtve.es/css/rtve.2019/rtve.compacts/p_final.content.noticias.reportajes.desktp.css"
        type="text/css">

    <link media="all" rel="stylesheet" href="https://css2.rtve.es/css/rtveplay.2021/rtve.play.grid_rtve.desktp.css"
        type="text/css">

    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css"
        type="text/css">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/detectizr/2.2.0/detectizr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"
        integrity="sha512-wNH6xsp2n8CfB91nrBtfc4sfLwYPBMjSWVUwQOp60AYYXH6i8yCwuKFZ4rgK2i6pQek/b+bSyR7b01/922IBzQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="./script_template.js"></script>
    <script src="https://npmcdn.com/csv2geojson@latest/csv2geojson.js"></script>
    <link media="all" rel="stylesheet" href="https://css2.rtve.es/css/rtve.2022.noticias/rentas/mapBox_15.desktp.css"
        type="text/css">
    <style type="text/css">
        iframe#_hjRemoteVarsFrame {
            display: none !important;
            width: 1px !important;
            height: 1px !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
    </style>


    <style id="onetrust-style">
        .mapboxgl-popup * {
            pointer-events: none;
        }


        #toggleButton {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        #hamburgerButton {
            font-size: 2rem;
            cursor: pointer;
        }

        #navigationLabel {
            font-size: 1.2rem;
            margin-left: 10px;
            /* Cambia este valor para ajustar la distancia entre el botón y el texto */
        }

        #navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 25%;
            margin: 0 auto;
        }

        #yearGrid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 5px;
            /* añade padding al grid */
            flex: 1;
        }

        #yearGrid button {
            padding: 5px;
            font-size: 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        #yearGrid button.selected {
            background-color: #888;
            color: white;
        }

        #yearGrid button:hover {
            background: #e0e0e0;
        }

        #yearGrid button:active {
            background: #d0d0e0;
        }

        #leftArrow,
        #rightArrow {
            font-size: 3rem;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 1rem;
        }


        
    </style>
</head>

<body>
    <div id="leyenda"><svg width="300" height="80" class="menu" transform="translate(100,50)">
            <g class="legendCells" transform="translate(18.8125,15)">
                <g class="cell" transform="translate(0,0)">
                    <rect class="swatch" height="15" width="50" style="fill: rgb(165, 0, 38);"></rect><text
                        class="label" transform="translate(25,
33)" style="text-anchor: middle;">Menor</text>
                </g>
                <g class="cell" transform="translate(52,0)">
                    <rect class="swatch" height="15" width="50" style="fill: rgb(254, 224, 144);"></rect><text
                        class="label" transform="translate(25,
33)" style="text-anchor: middle;"></text>
                </g>
                <g class="cell" transform="translate(104,0)">
                    <rect class="swatch" height="15" width="50" style="fill: rgb(224, 243, 248);"></rect><text
                        class="label" transform="translate(25,
33)" style="text-anchor: middle;"></text>
                </g>
                <g class="cell" transform="translate(156,0)">
                    <rect class="swatch" height="15" width="50" style="fill: rgb(49, 54, 149);"></rect><text
                        class="label" transform="translate(25,
33)" style="text-anchor: middle;"></text>
                </g>
            </g><text class="legendTitle"></text>
        </svg></div>
    <div id="map" class="mapboxgl-map">
        <div class="mapboxgl-canary" style="visibility: hidden;"></div>
        <div class="mapboxgl-canvas-container mapboxgl-interactive mapboxgl-touch-drag-pan mapboxgl-touch-zoom-rotate">
            <canvas class="mapboxgl-canvas" tabindex="0" aria-label="Map" role="region" width="512" height="1350"
                style="width: 256px; height: 675px;"></canvas>
        </div>
        <div class="mapboxgl-control-container">
            <div class="mapboxgl-ctrl-top-left"></div>
            <div class="mapboxgl-ctrl-top-right">
                <div class="mapboxgl-ctrl mapboxgl-ctrl-group"><button class="mapboxgl-ctrl-zoom-in" type="button"
                        title="Zoom in" aria-label="Zoom in" aria-disabled="false"><span class="mapboxgl-ctrl-icon"
                            aria-hidden="true"></span></button><button class="mapboxgl-ctrl-zoom-out" type="button"
                        title="Zoom out" aria-label="Zoom out" aria-disabled="false"><span class="mapboxgl-ctrl-icon"
                            aria-hidden="true"></span></button><button class="mapboxgl-ctrl-compass" type="button"
                        title="Reset bearing to north" aria-label="Reset bearing to north"><span
                            class="mapboxgl-ctrl-icon" aria-hidden="true"
                            style="transform: rotate(0deg);"></span></button>
                </div>
                <div class="mapboxgl-ctrl mapboxgl-ctrl-group"><button class="mapboxgl-ctrl-fullscreen" type="button"
                        aria-label="Enter fullscreen" title="Enter fullscreen"><span class="mapboxgl-ctrl-icon"
                            aria-hidden="true"></span></button></div>
            </div>
            <div class="mapboxgl-ctrl-bottom-left">
                <div class="mapboxgl-ctrl" style="display: block;"><a class="mapboxgl-ctrl-logo" target="_blank"
                        rel="noopener nofollow" href="https://www.mapbox.com/" aria-label="Mapbox logo"></a></div>
            </div>
            <div class="mapboxgl-ctrl-bottom-right">
                <div class="mapboxgl-ctrl mapboxgl-ctrl-attrib mapboxgl-compact">
                    <button class="mapboxgl-ctrl-attrib-button" title="Toggle attribution"
                        aria-label="Toggle attribution"></button>
                    <div class="mapboxgl-ctrl-attrib-inner" role="list"><a href="https://www.mapbox.com/about/maps/"
                            target="_blank" title="Mapbox" aria-label="Mapbox" role="listitem">© Mapbox</a>
                        <a href="https://www.openstreetmap.org/about/" target="_blank" title="OpenStreetMap"
                            aria-label="OpenStreetMap" role="listitem">©
                            OpenStreetMap</a> <a class="mapbox-improve-map"
                            href="https://apps.mapbox.com/feedback/?owner=datosrtve&amp;id=cl6f6yk79000214td4jnp3m09&amp;access_token=pk.eyJ1IjoiZGF0b3NydHZlIiwiYSI6ImNrczV5YW9sdDI1azUyb3BqZW91ZGRhbzMifQ.0vdRqqdlTOWqrOtg7ldSNQ"
                            target="_blank" title="Map feedback" aria-label="Map feedback" role="listitem"
                            rel="noopener nofollow">Improve this map</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="geocoder">
        <div class="mapboxgl-ctrl-geocoder mapboxgl-ctrl"><svg
                class="mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-search" viewBox="0 0 18 18"
                xml:space="preserve" width="18" height="18">
                <path
                    d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z">
                </path>
            </svg>
            <div class="suggestions-wrapper">
                <ul class="suggestions" style="display: none;"></ul>
            </div>
            <div class="mapboxgl-ctrl-geocoder--pin-right"><button aria-label="Clear"
                    class="mapboxgl-ctrl-geocoder--button"><svg
                        class="mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-close" viewBox="0 0 18 18"
                        xml:space="preserve" width="18" height="18">
                        <path
                            d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z">
                        </path>
                    </svg></button><svg class="mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-loading"
                    viewBox="0 0 18 18" xml:space="preserve" width="18" height="18">
                    <path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z">
                    </path>
                    <path opacity=".1"
                        d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z">
                    </path>
                </svg></div>
        </div>
    </div>
    <button type="button" title="center" class="btn_reset" id="fit"></button>
    <button type="button" title="center" class="btn_reset" id="spain">Península</button>
    <button type="button" title="center" class="btn_reset" id="canarias">Canarias</button>

    <div id="toggleButton">
        <button id="hamburgerButton">&#9776;</button>
        <span id="navigationLabel">Histórico de elecciones</span>
        <div id="navigation">
            <button id="leftArrow">&lt;</button>
            <div id="yearGrid"></div>
            <button id="rightArrow">&gt;</button>
        </div>
    </div>

    <!--
    <div id="vuelos">
        <button id="spain">España</button>
        <button id="canarias">Canarias</button>
    </div>
    -->

    <nav id="menu">
        <button id="DataActual" class="menu2020 active">PARTICIPACIÓN 2023</button>
        <!--<button id="DataPrevia" class="menuprevia">DataActual</button>-->
        <button id="VarData" class="menuprevia">VARIACIÓN</button>
    </nav>
    </div>

    <script>

        const csvUrl =
            "https://raw.githubusercontent.com/datosrtve/opendata/main/2023/elecciones_autonomicas_municipales_28M/participacion/municipales2023_participacion_mapbox.csv";
        //"https://raw.githubusercontent.com/datosrtve/censo-2021/main/data/censo_2021.csv";
        //"https://raw.githubusercontent.com/datosrtve/rentas/main/2022/data/rentas_mapbox.csv";
        //"https://raw.githubusercontent.com/datosrtve/rentas/main/2022/data/rentas_mapbox_2020_prueba02.csv";


        const csvPromise = papaPromise(csvUrl);

        mapboxgl.accessToken = "pk.eyJ1IjoiZGF0b3NydHZlIiwiYSI6ImNrczV5YW9sdDI1azUyb3BqZW91ZGRhbzMifQ.0vdRqqdlTOWqrOtg7ldSNQ";

        var locale = d3.formatLocale({
            decimal: ",",
            thousands: ".",
            grouping: [3]
        });
        let d_actual = [];
        let d_previo = [];
        let data_actual = [];
        let dataVar = [];
        let data_previo = [];
        let dataMunicipio = [];
        let dataProvincia = [];

        let data_actual_mun = [];
        let dataVar_Mun = [];
        let data_previo_mun = [];


        let step1, step2, step3, step4, step5, step6, step7, step8, step9, mindata, maxdata;
        let step1_Mun, step2_Mun, step3_Mun, step4_Mun, step5_Mun, step6_Mun, step7_Mun, step8_Mun, step9_Mun, mindata_Mun, maxdata_Mun;
        let step1_previo, step2_previo, step3_previo, step4_previo, step5_previo, step6_previo, step7_previo, step8_previo, step9_previo, mindata_previo, maxdata_previo;
        let step1_Mun_previo, step2_Mun_previo, step3_Mun_previo, step4_Mun_previo, step5_Mun_previo, step6_Mun_previo, step7_Mun_previo, step8_Mun_previo, step9_Mun_previo, mindata_Mun_previo, maxdata_Mun_previo;


        let color_escala = d3.scaleThreshold()
            .domain([step1_Mun, step4_Mun, step5_Mun, maxdata_Mun])
            .range(['#b3c6d9', '#7189af', '#3b4e83', '#111654']);

        let color_escala_variacion = d3.scaleThreshold()
            .range(['#8e5003', '#f6ebcd', '#d3ece6', '#03675f']);


            let incendiosPoint24 = {
            "type": "FeatureCollection",
            "features": []
        };


        function pintarPopup(dataMap, e, actived) {

            var props = dataMap[0].properties;
            var state = dataMap[0].state;
            var layer = dataMap[0].layer.id;
            let var_Data = '-';
            let var_DataPrevio = '-';
            let var_VarData = '';
            let var_VarData_eval = '';

            if ((state.d_actual) != 'NA') {
                var_Data = Intl.NumberFormat('de-DE').format(state.d_actual);
            } else {
                var_VarData_eval = 'Sin dato';
            }

            if ((state.d_previo) != 'NA') {
                var_DataPrevio = Intl.NumberFormat('de-DE').format(state.d_previo);
            } else {
                var_VarData_eval = 'Sin dato';
            }

            if (state.Seccion == undefined) {
                if ((state.var_mun_anual) != 'NA') {
                    var_VarData = (state.var_mun_var_anual > 0) ? locale.format(".2f")(state.var_mun_var_anual) : locale.format(".2f")(state.var_mun_var_anual);
                    if (var_VarData_eval != 'Sin dato') {
                        var_VarData_eval = var_VarData.substring(0, 1);
                    }
                }
            }
            //secciones
            else if ((state.variacion) != 'NA') {
                var_VarData = (state.variacion > 0) ? locale.format(".2f")(state.variacion) : locale.format(".2f")(state.variacion);
                if (var_VarData_eval != 'Sin dato') {
                    var_VarData_eval = var_VarData.substring(0, 1);
                }

            }


            if (state.Municipio == undefined) {
                var content = "<h2 class='data sin'>Sin datos</h2>";
            } else if ((state.d_previo == 'NA') && (state.d_actual == 'NA')) {
                var content = "<h4 class='municipio'>" + state.Municipio + "</h4>";
                content += "<h3 class='provincia'>" + state.Provincia + "</h3>";
                content += "<h2 class='data sin'>Sin datos</h2>";
            } else {
                var content = "<h4 class='municipio'>" + state.Municipio + "</h4>";
                content += "<h3 class='provincia'>" + state.Provincia + "</h3>";
                if (state.Poblacion != undefined) {
                    var poblacion = parseInt(state.Poblacion);
                    content += "<h3 class='poblacion'>" + poblacion.toLocaleString('es-ES') + " habitantes </h3>";
                }


                if (state.Seccion != undefined) {
                    content += "<h3 class='data seccion'>" + state.Seccion + "</h3>";
                }

                if (actived == '_2020') {
                    content += "<h2 class='data active'><strong>2023:</strong> " + var_Data + ' ' + "%" + "</h2>";
                    content += "<h2 class='data'><strong>2019:</strong> " + var_DataPrevio + ' ' + "%" + "</h2>";
                    if (var_VarData_eval != 'Sin dato') {
                        if (var_VarData_eval == '-') {
                            content += "<h2 class='data variacion baja'>Variación: " + var_VarData + "%" + "</h2>";
                        } else {
                            content += "<h2 class='data variacion sube'>Variación: " + var_VarData + "%" + "</h2>";
                        }
                    }
                } else if (actived == '_previa') {
                    content += "<h2 class='data'><strong>2019:</strong> " + var_Data + ' ' + "%" + "</h2>";
                    content += "<h2 class='data active'><strong>2023:</strong> " + var_DataPrevio + ' ' + "%" + "</h2>";
                    if (var_VarData_eval != 'Sin dato') {
                        if (var_VarData_eval == '-') {
                            content += "<h2 class='data variacion baja'>Variación: " + var_VarData + "%" + "</h2>";
                        } else {
                            content += "<h2 class='data variacion sube'>Variación: " + var_VarData + "%" + "</h2>";
                        }
                    }

                } if (actived == '_varia') {
                    content += "<h2 class='data'><strong>2019:</strong> " + var_Data + ' ' + "%" + "</h2>";
                    content += "<h2 class='data'><strong>2023:</strong> " + var_DataPrevio + ' ' + "%" + "</h2>";
                    if (var_VarData_eval != 'Sin dato') {
                        if (var_VarData_eval == '-') {
                            content += "<h2 class='data variacion active baja'>Variación: " + var_VarData + "</h2>";
                        } else {
                            content += "<h2 class='data variacion active sube'>Variación: " + var_VarData + "</h2>";
                        }
                    }
                }
            }
            popup.setLngLat(e.lngLat).setHTML(content).addTo(map);
            $('.mapboxgl-popup-content').css('border-color', (e.features[0].layer.paint['fill-color']).toString())
        }


        const bounds = [
            [-104.1059556369808, -7.481376773454173],
            [106.83154436302016, 68.58881756396005]
        ]

        let isMobile = false;
        if (Detectizr.device.type == 'mobile') {
            isMobile = true;
        }

        let initialZoom = isMobile ? 4 : 5.8;
        let initialCenter = isMobile ? [-3.3292966493690983, 40.06720017596038] : [-3.319216382839727, 40.14815887439099];


        var map = new mapboxgl.Map({
            container: "map",
            //style: "mapbox://styles/datosrtve/cl6f6yk79000214td4jnp3m09",
            style: "mapbox://styles/datosrtve/clb6i4gin003n14nt3vu8daad",
            zoom: initialZoom,
            center: initialCenter,
            maxBounds: bounds,
            cooperativeGestures: true,
            locale: {
                "ScrollZoomBlocker.CtrlMessage": "Usa ctrl + scroll para hacer zoom",
                "ScrollZoomBlocker.CmdMessage": "Use cmd + scroll para hacer zoom",
                "TouchPanBlocker.Message": "Usa dos dedos para moverte por el mapa"

            },
            transformRequest: transformRequest,
        });

        map.getBounds()

        // GEOCODER

        var geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            countries: "es",
            language: "es",
            types: "region, place, locality",
            marker: false,
            placeholder: "Buscar municipios",
        });

        map.dragRotate.disable();
        map.touchZoomRotate.disableRotation();
        map.addControl(new mapboxgl.NavigationControl());

        map.addControl(
            new mapboxgl.FullscreenControl({
                container: document.querySelector("body")
            })
        );

        document.getElementById("geocoder").appendChild(geocoder.onAdd(map));

        // FINAL DE GEOCODER

        let hoveredStateId = null;
        let hoveredStateMun = null;
        let hoveredStateVar = null;

        map.on("load", function () {
            csvPromise.then(function (results) {
                //console.table(results.data);

                results.data.forEach((row) => {
                    var id = 'cod_sec';
                    if (row.d_actual > 0) data_actual.push(parseInt(row.d_actual));
                    if (row.d_previo > 0) data_previo.push(parseInt(row.d_previo));
                    if (!isNaN(row.variacion)) dataVar.push(parseFloat(row.variacion));
                    dataMunicipio.push(row.municipio);
                    dataProvincia.push(row.provincia);

                })

                results.data.forEach((row) => {
                    var id = 'cod_mun';
                    if (row.d_actual > 0) data_actual_mun.push(parseInt(row.d_actual));
                    if (row.d_previo > 0) data_previo_mun.push(parseInt(row.d_previo));
                    if (!isNaN(row.variacion)) dataVar_Mun.push(parseFloat(row.variacion));
                    dataMunicipio.push(row.municipio);
                    dataProvincia.push(row.provincia);

                })



                let datos_escalas = d3.values(data_actual).sort(d3.ascending).filter(function (d) {
                    return d !== null && !isNaN(d) && d > 0
                })

                mindata = d3.min(datos_escalas)
                step1 = d3.quantile(datos_escalas, 0.1)
                step2 = d3.quantile(datos_escalas, 0.2)
                step3 = d3.quantile(datos_escalas, 0.3)
                step4 = d3.quantile(datos_escalas, 0.4)
                step5 = d3.quantile(datos_escalas, 0.5)
                step6 = d3.quantile(datos_escalas, 0.6)
                step7 = d3.quantile(datos_escalas, 0.7)
                step8 = d3.quantile(datos_escalas, 0.8)
                step9 = d3.quantile(datos_escalas, 0.9)
                maxdata = d3.max(datos_escalas)

                let datos_escalas_previo = d3.values(data_previo).sort(d3.ascending).filter(function (d) {
                    return d !== null && !isNaN(d) && d > 0
                })

                mindata_previo = d3.min(datos_escalas_previo)
                step1_previo = d3.quantile(datos_escalas_previo, 0.1)
                step2_previo = d3.quantile(datos_escalas_previo, 0.2)
                step3_previo = d3.quantile(datos_escalas_previo, 0.3)
                step4_previo = d3.quantile(datos_escalas_previo, 0.4)
                step5_previo = d3.quantile(datos_escalas_previo, 0.5)
                step6_previo = d3.quantile(datos_escalas_previo, 0.6)
                step7_previo = d3.quantile(datos_escalas_previo, 0.7)
                step8_previo = d3.quantile(datos_escalas_previo, 0.8)
                step9_previo = d3.quantile(datos_escalas_previo, 0.9)
                maxdata_previo = d3.max(datos_escalas_previo)


                let datos_escalas_Mun = d3.values(data_actual_mun).sort(d3.ascending).filter(function (d) {
                    return d !== null && !isNaN(d) && d > 0
                })

                mindata_Mun = d3.min(datos_escalas_Mun)
                step1_Mun = d3.quantile(datos_escalas_Mun, 0.1)
                step2_Mun = d3.quantile(datos_escalas_Mun, 0.2)
                step3_Mun = d3.quantile(datos_escalas_Mun, 0.3)
                step4_Mun = d3.quantile(datos_escalas_Mun, 0.4)
                step5_Mun = d3.quantile(datos_escalas_Mun, 0.5)
                step6_Mun = d3.quantile(datos_escalas_Mun, 0.6)
                step7_Mun = d3.quantile(datos_escalas_Mun, 0.7)
                step8_Mun = d3.quantile(datos_escalas_Mun, 0.8)
                step9_Mun = d3.quantile(datos_escalas_Mun, 0.9)
                maxdata_Mun = d3.max(datos_escalas_Mun)


                datos_escalas_Mun_previo = d3.values(data_previo_mun).sort(d3.ascending).filter(function (d) {
                    return d !== null && !isNaN(d)
                })

                mindata_Mun_previo = d3.min(datos_escalas_Mun_previo)
                step1_Mun_previo = d3.quantile(datos_escalas_Mun_previo, 0.1)
                step2_Mun_previo = d3.quantile(datos_escalas_Mun_previo, 0.2)
                step3_Mun_previo = d3.quantile(datos_escalas_Mun_previo, 0.3)
                step4_Mun_previo = d3.quantile(datos_escalas_Mun_previo, 0.4)
                step5_Mun_previo = d3.quantile(datos_escalas_Mun_previo, 0.5)
                step6_Mun_previo = d3.quantile(datos_escalas_Mun_previo, 0.6)
                step7_Mun_previo = d3.quantile(datos_escalas_Mun_previo, 0.7)
                step8_Mun_previo = d3.quantile(datos_escalas_Mun_previo, 0.8)
                step9_Mun_previo = d3.quantile(datos_escalas_Mun_previo, 0.9)
                maxdata_Mun_previo = d3.max(datos_escalas_Mun_previo)

                /* escala en dos pasos: censales*/
                let datos_escalas_Var_neg = d3.values(dataVar).sort(d3.ascending).filter(function (d) {
                    return d !== null && !isNaN(d) && d < 0
                });

                mindata_Var = d3.min(datos_escalas_Var_neg)
                step1_Var_neg = d3.quantile(datos_escalas_Var_neg, 0.2)
                step2_Var_neg = d3.quantile(datos_escalas_Var_neg, 0.4)
                step3_Var_neg = d3.quantile(datos_escalas_Var_neg, 0.6)
                step4_Var_neg = d3.quantile(datos_escalas_Var_neg, 0.8)
                maxdata_Var_neg = d3.max(datos_escalas_Var_neg)

                let datos_escalas_Var = d3.values(dataVar).sort(d3.ascending).filter(function (d) {
                    return d !== null && !isNaN(d) && d > 0
                });

                mindata_Var = d3.min(datos_escalas_Var)
                step5_Var = d3.quantile(datos_escalas_Var, 0.2)
                step6_Var = d3.quantile(datos_escalas_Var, 0.4)
                step7_Var = d3.quantile(datos_escalas_Var, 0.6)
                step8_Var = d3.quantile(datos_escalas_Var, 0.8)
                maxdata_Var = d3.max(datos_escalas_Var)


                /*datos: municipio*/
                let datos_escalas_Var_Mun_neg = d3.values(dataVar_Mun).sort(d3.ascending).filter(function (d) {
                    return d !== null && !isNaN(d) && d < 0
                });

                mindata_Var_Mun_neg = d3.min(datos_escalas_Var_Mun_neg)
                step1_Var_Mun_neg = d3.quantile(datos_escalas_Var_Mun_neg, 0.2)
                step2_Var_Mun_neg = d3.quantile(datos_escalas_Var_Mun_neg, 0.4)
                step3_Var_Mun_neg = d3.quantile(datos_escalas_Var_Mun_neg, 0.6)
                step4_Var_Mun_neg = d3.quantile(datos_escalas_Var_Mun_neg, 0.8)
                maxdata_Var_Mun_neg = d3.max(datos_escalas_Var_Mun_neg)


                let datos_escalas_Var_Mun = d3.values(dataVar_Mun).sort(d3.ascending).filter(function (d) {
                    return d !== null && !isNaN(d) && d > 0
                });

                mindata_Var_Mun = d3.min(datos_escalas_Var_Mun)
                step5_Var_Mun = d3.quantile(datos_escalas_Var_Mun, 0.2)
                step6_Var_Mun = d3.quantile(datos_escalas_Var_Mun, 0.4)
                step7_Var_Mun = d3.quantile(datos_escalas_Var_Mun, 0.6)
                step8_Var_Mun = d3.quantile(datos_escalas_Var_Mun, 0.8)
                maxdata_Var_Mun = d3.max(datos_escalas_Var_Mun)


                /*
                map.addSource("SeccionesCensales", {
                    type: "vector",
                    url: "mapbox://datosrtve.6nblbc7r",
                    promoteId: "cusec",
                });*/

                map.addSource("Municipios_ES", {
                    type: "vector",
                    url: "mapbox://datosrtve.da2q4t7c", //"mapbox://datosrtve.34x6feue"
                    promoteId: "CODIGOINE",
                });
                /*
                results.data.forEach((row) => {
                    map.setFeatureState(
                        {
                            source: "SeccionesCensales",
                            sourceLayer: "SeccionesCensales",
                            id: row.cod_sec,
                        },
                        {
                            d_actual: row.d_actual,
                            d_previo: row.d_previo,
                            variacion: row.variacion,
                            Seccion: row.dis_sec,
                            Municipio: row.municipio,
                            Provincia: row.provincia,
    
                        }
                    );
                });
                */

                results.data.forEach((row) => {
                    map.setFeatureState(
                        {
                            source: "Municipios_ES",
                            sourceLayer: "Municipios_ES",
                            id: row.cod_mun,
                        },
                        {
                            d_actual: row.d_actual,
                            d_previo: row.d_previo,
                            var_mun_var_anual: row.variacion,
                            Municipio: row.municipio,
                            Provincia: row.provincia,
                            Poblacion: row.pob,
                        }
                    );
                });
                initLayers();
                $('#DataActual').click();
                $('#distractor').addClass('hddn');


            });
        });

        var initLayers = function () {

            /*MUNICIPIOS 2020*/
            map.addLayer({
                id: "Municipios-fill",
                type: "fill",
                source: "Municipios_ES",
                "source-layer": "Municipios_ES",
                minzoom: 4,
                maxzoom: 12,
                layout: {

                },
                paint: {
                    'fill-color': [
                        'case',
                        ['==', ["feature-state", "d_actual"], "NA"], "#EDEDEA",
                        ['>', ["to-number", ["feature-state", "d_actual"]], 0],
                        ["interpolate", ["linear"], ["to-number", ["feature-state", "d_actual"]],
                            0, "#ffffff",
                            step1_Mun, "#b3c6d9",
                            step2_Mun, "#9bb1cb",
                            step3_Mun, "#859dbd",
                            step4_Mun, "#7189af",
                            step5_Mun, "#5d75a0",
                            step6_Mun, "#4c6192",
                            step7_Mun, "#3b4e83",
                            step8_Mun, "#2c3b74",
                            step9_Mun, "#1f2864",
                            maxdata_Mun, "#111654",
                        ],
                        "#EDEDEA"
                    ],
                    "fill-outline-color": "#cdcdcd",
                    "fill-opacity": 0.9,
                }
            }, "aeroway-line");

            /*SECCIONES CENSALES 2020*/
            /*
            map.addLayer({
                id: "SeccionesCensales-fill",
                type: "fill",
                source: "SeccionesCensales",
                "source-layer": "SeccionesCensales",
                minzoom: 9,
                layout: {},
                paint: {
                    'fill-color': [
                        'case',
                        ['==', ["feature-state", "d_actual"], "NA"], "#EDEDEA",
                        ['>', ["to-number", ["feature-state", "d_actual"]], 0],
                        ["interpolate", ["linear"], ["to-number", ["feature-state", "d_actual"]],
                            0, "#ffffff",
                            step1_previo, "#a50026",
                            step2_previo, "#d73027",
                            step3_previo, "#f46d43",
                            step4_previo, "#fdae61",
                            step5_previo, "#fee090",
                            step6_previo, "#e0f3f8",
                            step7_previo, "#abd9e9",
                            step8_previo, "#74add1",
                            step9_previo, "#4575b4",
                            maxdata, "#313695",
                        ],
                        "#EDEDEA"
                    ],
                    "fill-outline-color": "#cdcdcd",
                    "fill-opacity": 0.9,
                }
    
            }, "aeroway-line");
            */


            /*SECCIONES CENSALES previa*/
            /*
            map.addLayer({
                id: "SeccionesCensalesprevia-fill",
                type: "fill",
                source: "SeccionesCensales",
                "source-layer": "SeccionesCensales",
                minzoom: 9,
                layout: {},
                paint: {
                    'fill-color': [
                        'case',
                        ['==', ["feature-state", "d_previo"], "NA"], "#EDEDEA",
                        ['>', ["to-number", ["feature-state", "d_previo"]], 0],
                        ["interpolate", ["linear"], ["to-number", ["feature-state", "d_previo"]],
                            0, "#ffffff",
                            step1, "#a50026",
                            step2, "#d73027",
                            step3, "#f46d43",
                            step4, "#fdae61",
                            step5, "#fee090",
                            step6, "#e0f3f8",
                            step7, "#abd9e9",
                            step8, "#74add1",
                            step9, "#4575b4",
                            maxdata, "#313695",
                        ],
                        "#EDEDEA"
                    ],
                    "fill-outline-color": "#cdcdcd",
                    "fill-opacity": 0.9,
                }
    
            }, "aeroway-line");
            */

            map.addLayer({
                id: "Municipiosprevia-fill",
                type: "fill",
                source: "Municipios_ES",
                "source-layer": "Municipios_ES",
                minzoom: 4,
                layout: {

                },
                paint: {
                    'fill-color': [
                        'case',
                        ['==', ["feature-state", "d_previo"], "NA"], "#EDEDEA",
                        ['>', ["to-number", ["feature-state", "d_previo"]], 0],
                        ["interpolate", ["linear"], ["to-number", ["feature-state", "d_previo"]],
                            0, "#ffffff",
                            step1_Mun_previo, "#79a1ca",
                            step2_Mun_previo, "#6893c3",
                            step3_Mun_previo, "#5884bc",
                            step4_Mun_previo, "#4976b5",
                            step5_Mun_previo, "#3c68ad",
                            step6_Mun_previo, "#3059a4",
                            step7_Mun_previo, "#264b9b",
                            step8_Mun_previo, "#1e3c91",
                            step9_Mun_previo, "#182d86",
                            maxdata, "#161d7b",
                        ],
                        "#EDEDEA"
                    ],
                    "fill-outline-color": "#cdcdcd",
                    "fill-opacity": 0.9,
                }

            }, "aeroway-line");

            /*VARIACIONES Municipio*/
            map.addLayer({
                id: "VariacionesMun-fill",
                type: "fill",
                source: "Municipios_ES",
                "source-layer": "Municipios_ES",
                minzoom: 4,
                layout: {

                },
                paint: {
                    'fill-color': [
                        'case',
                        ['==', ["feature-state", "var_mun_var_anual"], "NA"], "#EDEDEA",
                        ['<', ["to-number", ["feature-state", "var_mun_var_anual"]], 0],
                        ["interpolate", ["linear"], ["to-number", ["feature-state", "var_mun_var_anual"]],
                            step1_Var_Mun_neg, "#8c5007",
                            step2_Var_Mun_neg, "#c5994e",
                            step3_Var_Mun_neg, "#e9cc94",
                            step4_Var_Mun_neg, "#f6ebcd",

                        ],
                        ['>', ["to-number", ["feature-state", "var_mun_var_anual"]], 0],
                        ["interpolate", ["linear"], ["to-number", ["feature-state", "var_mun_var_anual"]],
                            step5_Var_Mun, "#d6eae6",
                            step6_Var_Mun, "#a7cec3",
                            step7_Var_Mun, "#67918f",
                            step8_Var_Mun, "#47a198",
                            maxdata_Var_Mun, "#02665e",
                        ],
                        "#FDF3D9",
                    ],
                    "fill-outline-color": "#cdcdcd",
                    "fill-opacity": 0.9,
                }

            }, "aeroway-line");

            /*VARIACIONES Censales*/
            /*
            map.addLayer({
                id: "Variaciones-fill",
                type: "fill",
                source: "SeccionesCensales",
                "source-layer": "SeccionesCensales",
                minzoom: 9,
                layout: {},
                paint: {
                    'fill-color': [
                        'case',
                        ['==', ["feature-state", "variacion"], "NA"], "#EDEDEA",
                        ['<', ["to-number", ["feature-state", "variacion"]], 0],
                        ["interpolate", ["linear"], ["to-number", ["feature-state", "variacion"]],
                            step1_Var_neg, "#8c5007",
                            step2_Var_neg, "#c5994e",
                            step3_Var_neg, "#e9cc94",
                            step4_Var_neg, "#f6ebcd",
    
                        ],
                        ['>', ["to-number", ["feature-state", "variacion"]], 0],
                        ["interpolate", ["linear"], ["to-number", ["feature-state", "variacion"]],
                            /* step1_Var, "#8c5007",
                             step2_Var, "#c5994e",
                             step3_Var, "#e9cc94",
                             step4_Var, "#f6ebcd",*/
            /*
            step5_Var, "#f5f7ea",
            step6_Var, "#d6eae6",
            step7_Var, "#a7cec3",
            step8_Var, "#67918f",
            maxdata_Var, "#02665e",
        ],

        "#FDF3D9"
    ],
    "fill-outline-color": "#cdcdcd",
    "fill-opacity": 0.9,
}

}, "aeroway-line");
*/


            //Capa con bordes
            /*
            map.addLayer({
                id: "SeccionesCensales-line",
                type: "line",
                minzoom: 9,
                source: "SeccionesCensales",
                "source-layer": "SeccionesCensales",
                layout: {},
                paint: {
                    'line-color': ['case', ['boolean', ['feature-state', 'hover'], false], '#333333', 'white'],
                    "line-width": ['case', ['boolean', ['feature-state', 'hover'], false], 3, 0]
                },
            });
            */
            map.addLayer({
                id: "Municipios-line",
                type: "line",
                minzoom: 4,
                maxzoom: 12,
                source: "Municipios_ES",
                "source-layer": "Municipios_ES",
                layout: {},
                paint: {
                    'line-color': ['case', ['boolean', ['feature-state', 'hover'], false], '#333333', 'white'],
                    "line-width": ['case', ['boolean', ['feature-state', 'hover'], false], 3, 0]
                },
            });

        }



        var popup = new mapboxgl.Popup({
            closeButton: true, //false
            closeOnClick: false,
        });


        /*POPUP 2020 - DEFAULT OPCION*/
        map.on("mousemove", "Municipios-fill", function (e) {
            if (e.features.length > 0) {
                if (hoveredStateMun !== null) {
                    map.setFeatureState({
                        source: 'Municipios_ES',
                        sourceLayer: "Municipios_ES",
                        id: hoveredStateMun
                    },
                        { hover: false }
                    );
                }
                hoveredStateMun = e.features[0].id;
                map.setFeatureState({
                    source: 'Municipios_ES',
                    sourceLayer: "Municipios_ES",
                    id: hoveredStateMun
                },
                    { hover: true }
                );
            }

            map.getCanvas().style.cursor = "default";

            var dataMap = map.queryRenderedFeatures(e.point, {
                layers: ["Municipios-fill"],
            });

            var data_active = '_2020';
            pintarPopup(dataMap, e, data_active);

        });

        /*POPUP 2020 - DEFAULT OPCION*/
        map.on("mouseleave", "Municipios-fill", function () {

            if (hoveredStateMun !== null) {
                map.setFeatureState({
                    source: 'Municipios_ES',
                    sourceLayer: "Municipios_ES",
                    id: hoveredStateMun
                },
                    {
                        hover: false
                    }
                );
            }
            hoveredStateMun = null;

            map.getCanvas().style.cursor = "";
            popup.remove();
        });

        document.getElementById('fit').addEventListener('click', () => {
            map.fitBounds([
                /*
                [-0.1320872786934899, 45.68176311917412],
                [-7.506169142870249, 34.372511603434376]
                */
                [-10.797604824730342, 35.655603392376065],
                [3.1593484031746755, 43.85076923654901]
            ]);
        });

        // POPUP CENSALES on zoom
        map.on("mousemove", "SeccionesCensales-fill", function (e) {
            //Hover
            if (e.features.length > 0) {
                if (hoveredStateId !== null) {
                    map.setFeatureState({
                        source: 'SeccionesCensales',
                        sourceLayer: "SeccionesCensales",
                        id: hoveredStateId
                    },
                        { hover: false }
                    );
                }
                hoveredStateId = e.features[0].id;
                map.setFeatureState({
                    source: 'SeccionesCensales',
                    sourceLayer: "SeccionesCensales",
                    id: hoveredStateId
                },
                    { hover: true }
                );

            }

            var dataMap = map.queryRenderedFeatures(e.point, {
                layers: ["SeccionesCensales-fill"],
            });
            var actived = "_2020";
            pintarPopup(dataMap, e, actived);

            map.getCanvas().style.cursor = "default";

        });

        map.on("mouseleave", "SeccionesCensales-fill", function () {

            if (hoveredStateId !== null) {
                map.setFeatureState({
                    source: 'SeccionesCensales',
                    sourceLayer: "SeccionesCensales",
                    id: hoveredStateId
                },
                    {
                        hover: false
                    }
                );
            }
            hoveredStateId = null;

            map.getCanvas().style.cursor = "";
            popup.remove();

            var data_active = '_2020';
            pintarPopup(dataMap, e, actived);

        });


        /*POPUP previa */
        map.on("mousemove", "Municipiosprevia-fill", function (e) {
            if (e.features.length > 0) {
                if (hoveredStateMun !== null) {
                    map.setFeatureState({
                        source: 'Municipios_ES',
                        sourceLayer: "Municipios_ES",
                        id: hoveredStateMun
                    },
                        { hover: false }
                    );
                }
                hoveredStateMun = e.features[0].id;
                map.setFeatureState({
                    source: 'Municipios_ES',
                    sourceLayer: "Municipios_ES",
                    id: hoveredStateMun
                },
                    { hover: true }
                );
            }

            map.getCanvas().style.cursor = "default";

            var dataMap = map.queryRenderedFeatures(e.point, {
                layers: ["Municipiosprevia-fill"],
            });
            var actived = "_previa";
            pintarPopup(dataMap, e, actived);

        });

        map.on("mouseleave", "Municipiosprevia-fill", function () {

            if (hoveredStateMun !== null) {
                map.setFeatureState({
                    source: 'Municipios_ES',
                    sourceLayer: "Municipios_ES",
                    id: hoveredStateMun
                },
                    {
                        hover: false
                    }
                );
            }
            hoveredStateMun = null;

            map.getCanvas().style.cursor = "";
            popup.remove();
        });


        /*POPUP CENSALES previa*/
        map.on("mousemove", "SeccionesCensalesprevia-fill", function (e) {
            //Hover
            if (e.features.length > 0) {
                if (hoveredStateId !== null) {
                    map.setFeatureState({
                        source: 'SeccionesCensales',
                        sourceLayer: "SeccionesCensales",
                        id: hoveredStateId
                    },
                        { hover: false }
                    );
                }
                hoveredStateId = e.features[0].id;
                map.setFeatureState({
                    source: 'SeccionesCensales',
                    sourceLayer: "SeccionesCensales",
                    id: hoveredStateId
                },
                    { hover: true }
                );
            }

            map.getCanvas().style.cursor = "default";
            var dataMap = map.queryRenderedFeatures(e.point, {
                layers: ["SeccionesCensalesprevia-fill"],
            });

            var actived = "_previa";
            pintarPopup(dataMap, e, actived);
        });


        map.on("mouseleave", "SeccionesCensalesprevia-fill", function () {

            if (hoveredStateId !== null) {
                map.setFeatureState({
                    source: 'SeccionesCensales',
                    sourceLayer: "SeccionesCensales",
                    id: hoveredStateId
                },
                    {
                        hover: false
                    }
                );
            }
            hoveredStateId = null;

            map.getCanvas().style.cursor = "";
            popup.remove();
        });



        /* POPUP Variaciones Municipio previa 2017*/
        map.on("mousemove", "VariacionesMun-fill", function (e) {

            if (e.features.length > 0) {
                if (hoveredStateVar !== null) {
                    map.setFeatureState({
                        source: 'Municipios_ES',
                        sourceLayer: "Municipios_ES",
                        id: hoveredStateVar
                    },
                        { hover: false }
                    );
                }
                hoveredStateVar = e.features[0].id;
                map.setFeatureState({
                    source: 'Municipios_ES',
                    sourceLayer: "Municipios_ES",
                    id: hoveredStateVar
                },
                    { hover: true }
                );
            }

            map.getCanvas().style.cursor = "default";
            var dataMap = map.queryRenderedFeatures(e.point, {
                layers: ["VariacionesMun-fill"],
            });
            var actived = "_varia";
            pintarPopup(dataMap, e, actived);

        });


        map.on("mouseleave", "VariacionesMun-fill", function () {

            if (hoveredStateVar !== null) {
                map.setFeatureState({
                    source: 'Municipios_ES',
                    sourceLayer: "Municipios_ES",
                    id: hoveredStateVar
                },
                    {
                        hover: false
                    }
                );
            }
            hoveredStateVar = null;

            map.getCanvas().style.cursor = "";
            popup.remove();
        });


        /* Variaciones Censal previa 2017*/
        map.on("mousemove", "Variaciones-fill", function (e) {

            if (e.features.length > 0) {
                if (hoveredStateVar !== null) {
                    map.setFeatureState({
                        source: 'SeccionesCensales',
                        sourceLayer: "SeccionesCensales",
                        id: hoveredStateVar
                    },
                        { hover: false }
                    );
                }
                hoveredStateVar = e.features[0].id;
                map.setFeatureState({
                    source: 'SeccionesCensales',
                    sourceLayer: "SeccionesCensales",
                    id: hoveredStateVar
                },
                    { hover: true }
                );
            }

            map.getCanvas().style.cursor = "default";
            var dataMap = map.queryRenderedFeatures(e.point, {
                layers: ["Variaciones-fill"],
            });
            var actived = "_varia";
            pintarPopup(dataMap, e, actived);
        });


        map.on("mouseleave", "Variaciones-fill", function () {

            if (hoveredStateVar !== null) {
                map.setFeatureState({
                    source: 'SeccionesCensales',
                    sourceLayer: "SeccionesCensales",
                    id: hoveredStateVar
                },
                    {
                        hover: false
                    }
                );
            }
            hoveredStateVar = null;

            map.getCanvas().style.cursor = "";
            popup.remove();
        });


        var canariasBounds = [
            [-19.82829880098774, 21.929859841625856], //suroeste
            [-11.83017938181402, 34.43035740227728] //roeste
        ];
        const canariasCenter = [
            (canariasBounds[0][0] + canariasBounds[1][0]) / 2,
            (canariasBounds[0][1] + canariasBounds[1][1]) / 2
        ];

        document.getElementById('canarias').addEventListener('click', () => {
            $("#vuelos button").each((index, value) => {
                value.style.display = "block";
            });
            $("#vuelos #canarias").hide();
            map.flyTo({
                center: canariasCenter,
                zoom: 5.7
            });
        });

        document.getElementById('spain').addEventListener('click', () => {
            $("#vuelos button").each((index, value) => {
                value.style.display = "block";
            });
            //$("#vuelos #peninsula").hide();
            map.flyTo({
                center: initialCenter,
                zoom: initialZoom
            });
        });

        //$("#vuelos #peninsula").hide()



        function transformRequest(url, resourceType) {
            var isMapboxRequest =
                url.slice(8, 22) === "api.mapbox.com" ||
                url.slice(10, 26) === "tiles.mapbox.com";
            return {
                url: isMapboxRequest
                    ? url.replace("?", "?pluginName=dataJoins&")
                    : url,
            };
        }
        function papaPromise(url) {
            return new Promise(function (resolve, reject) {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: resolve,
                });
            });
        }


        // Nueva lista de años
        let years = ['2019-04-28', '2019-11-10'];

        // Índice del año seleccionado actualmente
        let selectedYearIndex = years.indexOf('2019-11-10');  // Inicializa con el índice del año 2019

        // Obtén el contenedor
        let yearGrid = document.getElementById('yearGrid');

        // Crear un botón para cada año
        years.forEach(function (year) {
            let btn = document.createElement('button'); // Crear un nuevo botón
            btn.textContent = year; // Configurar el texto del botón
            btn.value = year; // Configurar el valor del botón
            yearGrid.appendChild(btn); // Agregar el botón al contenedor
        });

        setTimeout(function () {
            // Función para obtener todos los botones de la cuadrícula
            let yearButtons = function () {
                return document.querySelectorAll("#yearGrid button");
            }

            // Función para seleccionar un botón de año por índice
            function selectYearButton(index) {
                console.log('Función selectYearButton llamada con índice:', index);  // Imprime cuando se llama a la función

                if (index >= 0 && index < yearButtons().length) {
                    console.log('Índice válido, clic en el botón:', index); // Imprime cuando se encuentra un índice válido
                    yearButtons()[index].click();  // Dispara un evento de clic en el botón correspondiente
                    selectedYearIndex = index; // Actualiza el índice del año seleccionado
                    console.log('Índice del año seleccionado actualizado a:', selectedYearIndex); // Imprime cuando se actualiza el índice del año seleccionado
                } else {
                    console.log('Índice inválido:', index);  // Imprime cuando se encuentra un índice inválido
                }
            }

            // Agregar un evento de clic a cada botón
            yearButtons().forEach(function (button, index) {
                button.addEventListener('click', function () {
                    // Aquí puedes poner el código para filtrar los datos en función del año seleccionado
                    // El valor del año es obtenido directamente del array 'years'
                    map.setFilter('VariacionesMun-fill', ['==', ['to-string', ['get', 'fecha']], years[index]]);
                    console.log('map.getFilter("VariacionesMun-fill")');
                    console.log(map.getFilter('VariacionesMun-fill'));
                    console.log('configuración de la capa')
                    console.log(map.getLayer('VariacionesMun-fill'));

                    // Obtén las características de la capa
                    var features = map.querySourceFeatures('Municipios_ES', {
                        sourceLayer: 'Municipios_ES',
                        filter: ['==', ['get', 'fecha'], years[index]]
                    });

                    // Actualiza el estado de las características
                    features.forEach(function (feature) {
                        map.setFeatureState(
                            { source: 'Municipios_ES', id: feature.id },
                            { partido_ganador: feature.properties.partido_ganador }
                        );
                    });

                    // Forza a Mapbox a realizar un re-renderizado de la capa
                    map.triggerRepaint();

                    // Elimina la clase "selected" de todos los botones
                    yearButtons().forEach((btn) => {
                        btn.classList.remove("selected");
                    });

                    // Agrega la clase "selected" al botón que se hizo clic
                    this.classList.add("selected");
                });
            });



            // Selecciona el botón del año 2019 al inicio
            yearButtons()[selectedYearIndex].classList.add("selected");

            // Obtén los botones de las flechas
            let leftArrowButton = document.getElementById("leftArrow");
            let rightArrowButton = document.getElementById("rightArrow");

            // Agrega un evento de clic a cada botón de flecha
            leftArrowButton.addEventListener("click", function () {
                selectYearButton(selectedYearIndex - 1);
            });
            rightArrowButton.addEventListener("click", function () {
                selectYearButton(selectedYearIndex + 1);
            });
        }, 0);


    </script>
</body>

</html>